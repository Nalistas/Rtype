<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dalton&#39;s RType: README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Dalton&#39;s RType<span id="projectnumber">&#160;v0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">README</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div align="center"> <h1>üèé side car</h1>
</div><div align="center"> <br  />
 Alternative way to code splitting <br  />
</div><div align="center"> <a href="https://www.npmjs.com/package/use-sidecar"><img src="https://img.shields.io/npm/v/use-sidecar.svg?style=flat-square" alt="" style="pointer-events: none;" class="inline"/> </a></div><div align="center"> <a href="https://travis-ci.org/theKashey/use-sidecar"><img src="https://img.shields.io/travis/theKashey/use-sidecar.svg?style=flat-square" alt="Build status" style="pointer-events: none;" class="inline"/> </a></div><div align="center"> <a href="https://www.npmjs.com/package/use-sidecar"><img src="https://img.shields.io/npm/dm/use-sidecar.svg" alt="npm downloads" style="pointer-events: none;" class="inline"/> </a></div><div align="center"> <a href="https://bundlephobia.com/result?p=use-sidecar"><img src="https://img.shields.io/bundlephobia/minzip/use-sidecar.svg" alt="bundle size" style="pointer-events: none;" class="inline"/> </a> <br  />
 <br  />
 </div><p>UI/Effects code splitting pattern</p><ul>
<li><a href="https://dev.to/thekashey/sidecar-for-a-code-splitting-1o8g">read the original article</a> to understand concepts behind.</li>
<li><a href="https://medium.com/@cramforce/designing-very-large-javascript-applications-6e013a3291a3">read how Google</a> split view and logic.</li>
<li><a href="https://developers.facebook.com/videos/2019/building-the-new-facebookcom-with-react-graphql-and-relay/">watch how Facebook</a> defers "interactivity" effects.</li>
</ul>
<h2><a class="anchor" id="autotoc_md13196"></a>
Terminology:</h2>
<ul>
<li><code>sidecar</code> - non UI component, which may carry effects for a paired UI component.</li>
<li><code>UI</code> - UI component, which interactivity is moved to a <code>sidecar</code>.</li>
</ul>
<p><code>UI</code> is a <em>view</em>, <code>sidecar</code> is the <em>logic</em> for it. Like Batman(UI) and his sidekick Robin(effects).</p>
<h2><a class="anchor" id="autotoc_md13197"></a>
Concept</h2>
<ul>
<li>a <code>package</code> exposes <b>3 entry points</b> using a <a href="https://github.com/theKashey/multiple-entry-points-example">nested <code>package.json</code> format</a>:<ul>
<li>default aka <code>combination</code>, and lets hope tree shaking will save you</li>
<li><code>UI</code>, with only UI part</li>
<li><code>sidecar</code>, with all the logic</li>
<li>&gt; <code>UI</code> + <code>sidecar</code> === <code>combination</code>. The size of <code>UI+sidecar</code> might a bit bigger than size of their <code>combination</code>. Use <a href="https://github.com/ai/size-limit">size-limit</a> to control their size independently.</li>
</ul>
</li>
<li>package uses a <code>medium</code> to talk with own sidecar, breaking explicit dependency.</li>
<li>if package depends on another <em>sidecar</em> package:<ul>
<li>it shall export dependency side car among own sidecar.</li>
<li>package imports own sidecar via <code>medium</code>, thus able to export multiple sidecars via one export.</li>
</ul>
</li>
<li>final consumer uses <code>sidecar</code> or <code>useSidecar</code> to combine pieces together. <br  />
</li>
</ul>
<h2><a class="anchor" id="autotoc_md13198"></a>
Rules</h2>
<ul>
<li><code>UI</code> components might use/import any other <code>UI</code> components</li>
<li><code>sidecar</code> could use/import any other <code>sidecar</code></li>
</ul>
<p>That would form two different code branches, you may load separately - UI first, and effect sidecar later. That also leads to a obvious consequence - <b>one sidecar may export all sidecars</b>.</p><ul>
<li>to decouple <code>sidecars</code> from module exports, and be able to pick "the right" one at any point you have to use <code>exportSidecar(medium, component)</code> to export it, and use the same <code>medium</code> to import it back.</li>
<li>this limitation is for <b>libraries only</b>, as long as in the usercode you might dynamically import whatever and whenever you want.</li>
<li><code>useMedium</code> is always async - action would be executed in a next tick, or on the logic load.</li>
<li><code>sidecar</code> is always async - is does not matter have you loaded logic or not - component would be rendered at least in the next tick.</li>
</ul>
<blockquote class="doxtable">
<p>&zwj;except <code>medium.read</code>, which synchronously read the data from a medium, </p>
</blockquote>
<p>and <code>medium.assingSyncMedium</code> which changes <code>useMedium</code> to be sync.</p>
<h2><a class="anchor" id="autotoc_md13199"></a>
SSR and usage tracking</h2>
<p>Sidecar pattern is clear:</p><ul>
<li>you dont need to use/render any <code>sidecars</code> on server.</li>
<li>you dont have to load <code>sidecars</code> prior main render.</li>
</ul>
<p>Thus - no usage tracking, and literally no SSR. It's just skipped.</p>
<h1><a class="anchor" id="autotoc_md13200"></a>
API</h1>
<h2><a class="anchor" id="autotoc_md13201"></a>
createMedium()</h2>
<ul>
<li>Type: Util. Creates shared effect medium for algebraic effect.</li>
<li>Goal: To decouple modules from each other.</li>
<li>Usage: <code>use</code> in UI side, and <code>assign</code> from side-car. All effects would be executed.</li>
<li>Analog: WeakMap, React.__SECRET_DOM_DO_NOT_USE_OR_YOU_WILL_BE_FIRED <div class="fragment"><div class="line">const medium = createMedium(defaultValue);</div>
<div class="line">const cancelCb = medium.useMedium(someData);</div>
<div class="line"> </div>
<div class="line">// like</div>
<div class="line">useEffect(() =&gt; medium.useMedium(someData), []);</div>
<div class="line"> </div>
<div class="line">medium.assignMedium(someDataProcessor)</div>
<div class="line"> </div>
<div class="line">// createSidecarMedium is a helper for createMedium to create a &quot;sidecar&quot; symbol</div>
<div class="line">const effectCar = createSidecarMedium();</div>
</div><!-- fragment --></li>
</ul>
<blockquote class="doxtable">
<p>&zwj;! For consistence <code>useMedium</code> is async - sidecar load status should not affect function behavior, </p>
</blockquote>
<p>thus effect would be always executed at least in the "next tick". You may alter this behavior by using <code>medium.assingSyncMedium</code>.</p>
<h2><a class="anchor" id="autotoc_md13202"></a>
exportSidecar(medium, component)</h2>
<ul>
<li>Type: HOC</li>
<li>Goal: store <code>component</code> inside <code>medium</code> and return external wrapper</li>
<li>Solving: decoupling module exports to support exporting multiple sidecars via a single entry point.</li>
<li>Usage: use to export a <code>sidecar</code></li>
<li>Analog: WeakMap <div class="fragment"><div class="line">import {effectCar} from &#39;./medium&#39;;</div>
<div class="line">import {EffectComponent} from &#39;./Effect&#39;;</div>
<div class="line">// !!! - to prevent Effect from being imported</div>
<div class="line">// `effectCar` medium __have__ to be defined in another file</div>
<div class="line">// const effectCar = createSidecarMedium();</div>
<div class="line">export default exportSidecar(effectCar, EffectComponent);</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md13203"></a>
sidecar(importer)</h2>
<ul>
<li>Type: HOC</li>
<li>Goal: React.lazy analog for code splitting, but does not require <code>Suspense</code>, might provide error failback.</li>
<li>Usage: like React.lazy to load a side-car component.</li>
<li>Analog: React.Lazy <div class="fragment"><div class="line">import {sidecar} from &quot;use-sidecar&quot;;</div>
<div class="line">const Sidecar =  sidecar(() =&gt; import(&#39;./sidecar&#39;), &lt;span&gt;on fail&lt;/span&gt;);</div>
<div class="line"> </div>
<div class="line">&lt;&gt;</div>
<div class="line"> &lt;Sidecar /&gt;</div>
<div class="line"> &lt;UI /&gt;</div>
<div class="line">&lt;/&gt; </div>
</div><!-- fragment --> </li>
</ul>
<h3><a class="anchor" id="autotoc_md13204"></a>
Importing <code>exportedSidecar</code></h3>
<p>Would require additional prop to be set - <code>&lt;Sidecar sideCar={effectCar} /&gt;</code></p>
<h2><a class="anchor" id="autotoc_md13205"></a>
useSidecar(importer)</h2>
<ul>
<li>Type: hook, loads a <code>sideCar</code> using provided <code>importer</code> which shall follow React.lazy API</li>
<li>Goal: to load a side car without displaying any "spinners".</li>
<li>Usage: load side car for a component</li>
<li>Analog: none <div class="fragment"><div class="line">import {useSidecar} from &#39;use-sidecar&#39;;</div>
<div class="line"> </div>
<div class="line">const [Car, error] = useSidecar(() =&gt; import(&#39;./sideCar&#39;));</div>
<div class="line">return (</div>
<div class="line">  &lt;&gt;</div>
<div class="line">    {Car ? &lt;Car {...props} /&gt; : null}</div>
<div class="line">    &lt;UIComponent {...props}&gt;</div>
<div class="line">  &lt;/&gt;</div>
<div class="line">); </div>
</div><!-- fragment --> </li>
</ul>
<h3><a class="anchor" id="autotoc_md13206"></a>
Importing <code>exportedSideCar</code></h3>
<p>You have to specify <b>effect medium</b> to read data from, as long as <b>export itself is empty</b>. </p><div class="fragment"><div class="line">import {useSidecar} from &#39;use-sidecar&#39;;</div>
<div class="line"> </div>
<div class="line">/* medium.js: */ export const effectCar = useMedium({});</div>
<div class="line">/* sideCar.js: */export default exportSidecar(effectCar, EffectComponent);</div>
<div class="line"> </div>
<div class="line">const [Car, error] = useSidecar(() =&gt; import(&#39;./sideCar&#39;), effectCar); </div>
<div class="line">return (</div>
<div class="line">  &lt;&gt;</div>
<div class="line">    {Car ? &lt;Car {...props} /&gt; : null}</div>
<div class="line">    &lt;UIComponent {...props}&gt;</div>
<div class="line">  &lt;/&gt;</div>
<div class="line">);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13207"></a>
renderCar(Component)</h2>
<ul>
<li>Type: HOC, moves renderProp component to a side channel</li>
<li>Goal: Provide render prop support, ie defer component loading keeping tree untouched.</li>
<li>Usage: Provide <code>defaults</code> and use them until sidecar is loaded letting you code split (non visual) render-prop component</li>
<li>Analog: - Analog: code split library like <a href="https://github.com/theKashey/react-imported-library">react-imported-library</a> or <a href="https://www.smooth-code.com/open-source/loadable-components/docs/library-splitting/">@loadable/lib</a>. <div class="fragment"><div class="line">import {renderCar, sidecar} from &quot;use-sidecar&quot;;</div>
<div class="line">const RenderCar = renderCar(</div>
<div class="line">  // will move side car to a side channel</div>
<div class="line">  sidecar(() =&gt; import(&#39;react-powerplug&#39;).then(imports =&gt; imports.Value)),</div>
<div class="line">  // default render props</div>
<div class="line">  [{value: 0}]  </div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line">&lt;RenderCar&gt;</div>
<div class="line">  {({value}) =&gt; &lt;span&gt;{value}&lt;/span&gt;}</div>
<div class="line">&lt;/RenderCar&gt;</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md13208"></a>
setConfig(config)</h2>
<div class="fragment"><div class="line">setConfig({</div>
<div class="line">  onError, // sets default error handler</div>
<div class="line">});</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md13209"></a>
Examples</h1>
<h2><a class="anchor" id="autotoc_md13210"></a>
Deferred effect</h2>
<p>Let's imagine - on element focus you have to do "something", for example focus anther element</p>
<h4><a class="anchor" id="autotoc_md13211"></a>
Original code</h4>
<div class="fragment"><div class="line">onFocus = event =&gt; {</div>
<div class="line">  if (event.currentTarget === event.target) {</div>
<div class="line">    document.querySelectorAll(&#39;button&#39;, event.currentTarget)</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md13212"></a>
Sidecar code</h4>
<ol type="1">
<li>Use medium (yes, .3) <div class="fragment"><div class="line">// we are calling medium with an original event as an argument</div>
<div class="line">const onFocus = event =&gt; focusMedium.useMedium(event);</div>
</div><!-- fragment --></li>
</ol>
<ol type="1">
<li>Define reaction <div class="fragment"><div class="line">// in a sidecar</div>
<div class="line"> </div>
<div class="line">// we are setting handler for the effect medium</div>
<div class="line">// effect is complicated - we are skipping event &quot;bubbling&quot;, </div>
<div class="line">// and focusing some button inside a parent</div>
<div class="line">focusMedium.assignMedium(event =&gt; {</div>
<div class="line">  if (event.currentTarget === event.target) {</div>
<div class="line">    document.querySelectorAll(&#39;button&#39;, event.currentTarget)</div>
<div class="line">  }</div>
<div class="line">});</div>
</div><!-- fragment --></li>
</ol>
<ol type="1">
<li>Create medium Having these constrains - we have to clone <code>event</code>, as long as React would eventually reuse SyntheticEvent, thus not preserve <code>target</code> and <code>currentTarget</code>. <div class="fragment"><div class="line">// </div>
<div class="line">const focusMedium = createMedium(null, event =&gt; ({...event}));</div>
</div><!-- fragment --> Now medium side effect is ok to be async</li>
</ol>
<p><b>Example</b>: <a href="https://github.com/theKashey/react-focus-lock/blob/8c69c644ecfeed2ec9dc0dc4b5b30e896a366738/src/Lock.js#L48">Effect for react-focus-lock</a> - 1kb UI, 4kb sidecar</p>
<h3><a class="anchor" id="autotoc_md13213"></a>
Medium callback</h3>
<p>Like a library level code splitting</p>
<h4><a class="anchor" id="autotoc_md13214"></a>
Original code</h4>
<div class="fragment"><div class="line">import {x, y} from &#39;./utils&#39;;</div>
<div class="line"> </div>
<div class="line">useEffect(() =&gt; {</div>
<div class="line">  if (x()) {</div>
<div class="line">    y()</div>
<div class="line">  }</div>
<div class="line">}, []);</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md13215"></a>
Sidecar code</h4>
<div class="fragment"><div class="line">// medium</div>
<div class="line">const utilMedium = createMedium();</div>
<div class="line"> </div>
<div class="line">// utils</div>
<div class="line">const x = () =&gt; { /* ... */};</div>
<div class="line">const y = () =&gt; { /* ... */};</div>
<div class="line"> </div>
<div class="line">// medium will callback with exports exposed</div>
<div class="line">utilMedium.assignMedium(cb =&gt; cb({</div>
<div class="line"> x, y</div>
<div class="line">}));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">// UI</div>
<div class="line">// not importing x and y from the module system, but would be given via callback</div>
<div class="line">useEffect(() =&gt; {</div>
<div class="line">  utilMedium.useMedium(({x,y}) =&gt; {</div>
<div class="line">      if (x()) {</div>
<div class="line">        y()</div>
<div class="line">      }</div>
<div class="line">  })</div>
<div class="line">}, []);</div>
</div><!-- fragment --><ul>
<li>Hint: there is a easy way to type it <div class="fragment"><div class="line">const utilMedium = createMedium&lt;(cb: typeof import(&#39;./utils&#39;)) =&gt; void&gt;();</div>
</div><!-- fragment --></li>
</ul>
<p><b>Example</b>: <a href="https://github.com/theKashey/react-focus-lock/blob/8c69c644ecfeed2ec9dc0dc4b5b30e896a366738/src/MoveFocusInside.js#L12">Callback API for react-focus-lock</a></p>
<h3><a class="anchor" id="autotoc_md13216"></a>
Split effects</h3>
<p>Lets take an example from a Google - Calendar app, with view and logic separated. To be honest - it's not easy to extract logic from application like calendar - usually it's tight coupled.</p>
<h4><a class="anchor" id="autotoc_md13217"></a>
Original code</h4>
<div class="fragment"><div class="line">const CalendarUI = () =&gt; { </div>
<div class="line">  const [date, setDate] = useState();</div>
<div class="line">  const onButtonClick = useCallback(() =&gt; setDate(Date.now), []);</div>
<div class="line">  </div>
<div class="line">  return (</div>
<div class="line">    &lt;&gt;</div>
<div class="line">     &lt;input type=&quot;date&quot; onChange={setDate} value={date} /&gt;</div>
<div class="line">     &lt;input type=&quot;button&quot; onClick={onButtonClick}&gt;Set Today&lt;/button&gt;</div>
<div class="line">    &lt;/&gt;</div>
<div class="line">  )</div>
<div class="line">}</div>
</div><!-- fragment --> <h4><a class="anchor" id="autotoc_md13218"></a>
Sidecar code</h4>
<div class="fragment"><div class="line">const CalendarUI = () =&gt; {</div>
<div class="line">  const [events, setEvents] = useState({});</div>
<div class="line">  const [date, setDate] = useState();</div>
<div class="line">  </div>
<div class="line">  return (</div>
<div class="line">    &lt;&gt;</div>
<div class="line">     &lt;Sidecar setDate={setDate} setEvents={setEvents}/&gt;</div>
<div class="line">     &lt;UILayout {...events} date={date}/&gt;</div>
<div class="line">    &lt;/&gt;</div>
<div class="line">  )</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">const UILayout = ({onDateChange, onButtonClick, date}) =&gt; (</div>
<div class="line">  &lt;&gt;</div>
<div class="line">      &lt;input type=&quot;date&quot; onChange={onDateChange} value={date} /&gt;</div>
<div class="line">      &lt;input type=&quot;button&quot; onClick={onButtonClick}&gt;Set Today&lt;/button&gt;</div>
<div class="line">  &lt;/&gt;</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line">// in a sidecar</div>
<div class="line">// we are providing callbacks back to UI</div>
<div class="line">const Sidecar = ({setDate, setEvents}) =&gt; {</div>
<div class="line">  useEffect(() =&gt; setEvents({</div>
<div class="line">      onDateChange:setDate,</div>
<div class="line">      onButtonClick: () =&gt; setDate(Date.now),</div>
<div class="line">  }), []);</div>
<div class="line">  </div>
<div class="line">  return null;</div>
<div class="line">}</div>
</div><!-- fragment --><p>While in this example this looks a bit, you know, strange - there are 3 times more code that in the original example - that would make a sense for a real Calendar, especially if some helper library, like <code>moment</code>, has been used.</p>
<p><b>Example</b>: <a href="https://github.com/theKashey/react-remove-scroll/blob/666472d5c77fb6c4e5beffdde87c53ae63ef42c5/src/SideEffect.tsx#L166">Effect for react-remove-scroll</a> - 300b UI, 2kb sidecar</p>
<h1><a class="anchor" id="autotoc_md13219"></a>
Licence</h1>
<p>MIT </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
